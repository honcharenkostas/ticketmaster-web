{% extends "layout.html" %}

{% block content %}
<h5>Event Tickets</h2>
<div class="text text-muted mb-4">
  Total records: {{ total }}
</div>

{% if request.query_params.get('error') %}
<div class="alert alert-danger" role="alert">
  {{ request.query_params.get('error') }}
</div>
{% endif %}
<div id="errors" class="alert alert-danger d-none" role="alert"></div>

{% if events %}
    <div id="table-loader" class="text-center my-3 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="table-container">
        <table class="table table-bordered">
            <thead class="table-light align-middle">
                <tr class="text-center">
                    <th>#</th>
                    <th>Event Name</th>
                    <th>Account</th>
                    <th>Section</th>
                    <th>Row	#</th>
                    <th>Price</th>
                    <th>Amount</th>
                    <th>Full<br>Price</th>
                    <th>Price<br>+ Fees</th>
                    <th>Expire<br>in</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                {% if event.status == Event.STATUS_SCHEDULED %}
                <tr class="table-success text-center">
                {% elif event.status == Event.STATUS_FAILED %}
                <tr class="table-danger text-center">
                {% else %}
                <tr class="text-center">
                {% endif %}
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.id }}</td> <!-- id -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.event_name }}</td> <!-- Event Name -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.bot_email }}</td> <!-- Account -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.section }}</td> <!-- Section -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.row }}</td> <!-- Row	# -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.price }}</td> <!-- Price -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.amount }}</td> <!-- Amount -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.full_price }}</td> <!-- Full Price -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.price_plus_fees }}</td> <!-- Price + Fees -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable">{{ event.expire_at }}</td> <!-- Expire in -->
                    <td data-bs-toggle="collapse" data-bs-target="#details-{{event.id}}" class="clickable"> {{ event.status }}</td> <!-- Status -->
                    <td class="d-flex justify-content-center align-items-center gap-2">
                        {% if event.status == Event.STATUS_NEW %}
                        <button data-event-id="{{ event.id }}" class="btn btn-sm btn-success buy-ticket">&nbsp;&nbsp;Buy&nbsp;&nbsp;</a>
                        {% else %}
                        <button data-event-id="{{ event.id }}" class="btn btn-sm btn-success buy-ticket" disabled>&nbsp;&nbsp;Buy&nbsp;&nbsp;</a>
                        {% endif %}
                        <button data-event-id="{{ event.id }}" class="btn btn-sm btn-danger delete-event">Delete</a>
                    </td>
                </tr>
                <tr class="collapse" id="details-{{event.id}}">
                    <td colspan="11">
                        &nbsp;&nbsp;&nbsp;&nbsp;Event ID: {{event.event_id}}<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;Created At: {{event.created_at.strftime("%Y-%m-%d %H:%M:%S")}}<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;Checkout Link: <a href="{{ event.encsoft_url }}" target="_blank">{{ event.encsoft_url }}</a><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;CVV: {{ event.cvv }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="d-flex justify-contents align-items-center my-4">
            <nav>
                <ul class="pagination mb-0">
                {% if offset >= limit %}
                <li class="page-item">
                    <a class="page-link" href="/dashboard?offset={{ offset - limit }}&limit={{ limit }}">Previous</a>
                </li>
                {% endif %}
                {% if events|length == limit %}
                <li class="page-item">
                    <a class="page-link" href="/dashboard?offset={{ offset + limit }}&limit={{ limit }}">Next</a>
                </li>
                {% endif %}
                </ul>
            </nav>
        </div>
    </div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".buy-ticket").forEach(btn => {
            btn.addEventListener("click", async function (e) {
                e.preventDefault();
                const row = btn.closest("tr");
                const eventId = btn.dataset.eventId;

                document.getElementById("table-container").classList.add("d-none");
                document.getElementById("table-loader").classList.remove("d-none");

                try {
                    const response = await fetch(`/buy-ticket/${eventId}`, { method: "POST" });
                    const data = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        document.getElementById("table-container").classList.remove("d-none");
                        document.getElementById("table-loader").classList.add("d-none");
                        document.getElementById("errors").classList.remove("d-none");
                        document.getElementById("errors").innerText = data.error || "Internal server error";
                    }
                } catch (err) {
                    document.getElementById("errors").classList.remove("d-none");
                    document.getElementById("errors").innerText = "Scheduling buying ticket failed";
                    document.getElementById("table-container").classList.remove("d-none");
                    document.getElementById("table-loader").classList.add("d-none");
                }
            });
        });

        document.querySelectorAll(".delete-event").forEach(btn => {
            btn.addEventListener("click", async function (e) {
                e.preventDefault();
                const row = btn.closest("tr");
                const eventId = btn.dataset.eventId;

                document.getElementById("table-container").classList.add("d-none");
                document.getElementById("table-loader").classList.remove("d-none");

                try {
                    const response = await fetch(`/event/${eventId}`, {method: "DELETE"});
                    const data = await response.json();

                    if (response.ok) {
                        location.reload();
                    } else {
                        document.getElementById("table-container").classList.remove("d-none");
                        document.getElementById("table-loader").classList.add("d-none");
                        document.getElementById("errors").classList.remove("d-none");
                        document.getElementById("errors").innerText = "Internal server error";
                    }
                } catch (err) {
                    document.getElementById("errors").classList.remove("d-none");
                    document.getElementById("errors").innerText = "Delete request failed";
                    document.getElementById("table-container").classList.remove("d-none");
                    document.getElementById("table-loader").classList.add("d-none");
                }
            });
        });
    });
</script>
{% endblock %}
