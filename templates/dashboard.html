{% extends "layout.html" %}

{% block content %}
<h5>Tickets</h5>
<div class="d-flex align-items-center text text-muted mb-4">
  <input type="hidden" id="page" value=1>
  <input type="hidden" id="event_id" value="any">

  <label for="eventSelect" class="mb-0">Event Name &nbsp;&nbsp;&nbsp;</label>
  
  <select id="eventSelect" class="form-select form-select-sm" style="width: 250px;">
    <option selected>Any</option>
    <option value="1">Event 1</option>
    <option value="2">Event 2</option>
    <option value="3">Event 3</option>
  </select>
  
  <div class="ms-auto">Total: <span id="events_total"></span></div>

</div>

{% if request.query_params.get('error') %}
<div class="alert alert-danger" role="alert">
  {{ request.query_params.get('error') }}
</div>
{% endif %}
<div id="errors" class="alert alert-danger d-none" role="alert"></div>

<div id="table-container">
    <table class="table table-bordered">
        <thead class="table-light align-middle">
            <tr class="text-center">
                <th>#</th>
                <th>Account</th>
                <th>Event Name</th>
                <th>Section</th>
                <th>Row	#</th>
                <th>Price</th>
                <th>Amount</th>
                <th>Full<br>Price</th>
                <th>Price<br>+ Fees</th>
                <th>Expire<br>in</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="events-list">
            {% for event in events %}
            {% if event.status == Event.STATUS_SCHEDULED %}
            <tr id="event_{{event.id}}" class="table-success text-center fade show">
            {% elif event.status == Event.STATUS_FAILED %}
            <tr id="event_{{event.id}}" class="table-danger text-center fade show">
            {% elif event.expire_at == "expired" %}
            <tr id="event_{{event.id}}" class="table-secondary text-center fade show">
            {% else %}
            <tr id="event_{{event.id}}" class="text-center fade show">
            {% endif %}
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_id">{{ event.id }}</td> <!-- id -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_name">{{ event.event_name }}</td> <!-- Event Name -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle bot_email">{{ event.bot_email }}</td> <!-- Account -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_section">{{ event.section }}</td> <!-- Section -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_row">{{ event.row }}</td> <!-- Row	# -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_price">{{ event.price }}</td> <!-- Price -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_amount">{{ event.amount }}</td> <!-- Amount -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_full_price">{{ event.full_price }}</td> <!-- Full Price -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_price_plus_fees">{{ event.price_plus_fees }}</td> <!-- Price + Fees -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable countdown px-0 py-0 align-middle event_expire_at">{{ event.expire_at }}</td> <!-- Expire in -->
                <td data-bs-toggle="collapse" data-bs-target="#details_{{event.id}}" class="clickable px-0 py-0 align-middle event_status">{{ event.status }}</td> <!-- Status -->
                <td class="d-flex justify-content-center align-items-center gap-2 event_action">
                    {% if event.status == Event.STATUS_NEW and event.expire_at != "expired" %}
                    <button data-event-id="{{ event.id }}" class="btn btn-sm btn-success buy-ticket px-0 py-0">&nbsp;&nbsp;Buy&nbsp;&nbsp;</a>
                    {% else %}
                    <button data-event-id="{{ event.id }}" class="btn btn-sm btn-success buy-ticket px-0 py-0" disabled>&nbsp;&nbsp;Buy&nbsp;&nbsp;</a>
                    {% endif %}
                </td>
            </tr>

            <tr class="collapse" id="details_{{ event.id }}">
                <td colspan="12">
                    &nbsp;&nbsp;&nbsp;&nbsp;Event ID: <span class="event_id">{{ event.event_id }}</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;Checkout Link: <a href="{{ event.encsoft_url }}" target="_blank" class="event_encsoft_url">{{ event.encsoft_url }}</a><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;CVV: <span class="event_cvv">{{ event.cvv }}</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentPage = 1;
    let event_id = "any"
    const perPage = 25;

    function loadPage(page) {
        $.getJSON("/items/", { page: page, event_id:  event_id}, function(data) {
            $("#events_total").html(data.total)

            currentPage = data.page;
            // Populate table
            let rows = "";
            data.items.forEach(event => {
                $("#event_" + event.id + " .event_id").html(event.id);
                $("#event_" + event.id + " .event_name").html(event.event_name);
                $("#event_" + event.id + " .bot_email").html(event.bot_email);
                $("#event_" + event.id + " .event_section").html(event.section);
                $("#event_" + event.id + " .event_row").html(event.row);
                $("#event_" + event.id + " .event_price").html(event.price);
                $("#event_" + event.id + " .event_amount").html(event.amount);
                $("#event_" + event.id + " .event_full_price").html(event.full_price);
                $("#event_" + event.id + " .event_price_plus_fees").html(event.price_plus_fees);
                $("#event_" + event.id + " .event_expire_at").html(event.expire_at);

                $("#details_" + event.id + " .event_id").html(event.event_id);
                $("#details_" + event.id + " .event_encsoft_url").html(event.encsoft_url);
                $("#details_" + event.id + " .event_cvv").html(event.cvv);
                
                if (event.status == "scheduled") {
                    $("#event_" + event.id).attr("class", "table-success text-center fade show");
                } else if (event.status == "failed") {
                    $("#event_" + event.id).attr("class", "table-danger text-center fade show");
                } else if (event.expire_at == "expired") {
                    $("#event_" + event.id).attr("class", "table-secondary text-center fade show");
                } else {
                    $("#event_" + event.id).attr("class", "text-center fade show");
                }
            });
        });
    }

    // Initial load
    loadPage(currentPage);

    // Auto reload every 5 seconds, keep current page
    setInterval(() => {
        loadPage(currentPage);
    }, 5000);

    // TODO #2:
    // 1. implement pagination block (including event_id, page)

    // TODO #3:
    // 1. implement buy action

    // TODO #4:
    // 1. implemet error handling

</script>
{% endblock %}
