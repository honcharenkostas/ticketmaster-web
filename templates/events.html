{% extends "layout.html" %}

{% block content %}
<div class="d-flex align-items-center text text-muted py-3">
  <div class="ms-auto">Total: <span id="events_total">{{ total }}</span></div>
</div>

{% if request.query_params.get('error') %}
<div class="alert alert-danger" role="alert">
  {{ request.query_params.get('error') }}
</div>
{% endif %}
<div id="errors" class="alert alert-danger d-none" role="alert"></div>

<div id="table-container">
    <table class="table table-bordered">
        <thead class="table-light align-middle">
            <tr class="text-center">
                <th>Event ID</th>
                <th>Event Name</th>
                <th>Full Price Total</th>
            </tr>
        </thead>
        <tbody id="events-list">
            {% for row in events %}
            <tr class="text-center" id="event_{{row['event_id']}}">
                <td class="px-0 py-0 align-middle event_id">{{ row['event_id'] }}</td>
                <td class="px-0 py-0 align-middle event_name">{{ row['event_name'] }}</td>
                <td class="px-0 py-0 align-middle full_price_total">{{ row['full_price_total'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total > per_page %}
<nav aria-label="Page navigation">
    {% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page == 1 %}active{% endif %}">
            <a class="page-link" href="?page=1">1</a>
        </li>

        {% if page > 4 %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}

        {% set start = page - 2 if page - 2 > 2 else 2 %}
        {% set end = page + 2 if page + 2 < total_pages - 1 else total_pages - 1 %}

        {% for p in range(start, end + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
        </li>
        {% endfor %}

        {% if page < total_pages - 3 %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}

        {% if total_pages > 1 %}
        <li class="page-item {% if page == total_pages %}active{% endif %}">
            <a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
<script>
    $(window).on("load", function() {
        const perPage = 25;
        let currentPage = 1;

        function loadPage(page) {
            $.getJSON("/events/", { page: page}, function(data) {
                currentPage = data.page;
                $("#events_total").html(data.total)
                
                let rows = "";
                data.events.forEach(event => {
                    console.log(event)
                    $("#event_" + event['event_id'] + " .event_id").html(event['event_id']);
                    $("#event_" + event['event_id'] + " .event_name").html(event['event_name']);
                    $("#event_" + event['event_id'] + " .full_price_total").html(event['full_price_total']);
                });
            });
        }

        // Initial load
        loadPage(currentPage);
        // Auto reload every 5 seconds, keep current page
        setInterval(() => {
            loadPage(currentPage);
        }, 5000);
    });
</script>
{% endblock %}
